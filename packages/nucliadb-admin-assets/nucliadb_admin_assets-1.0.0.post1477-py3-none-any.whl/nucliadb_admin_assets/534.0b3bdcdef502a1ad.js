"use strict";(self.webpackChunknucliadb_admin=self.webpackChunknucliadb_admin||[]).push([[534],{153:(zt,j,a)=>{a.r(j),a.d(j,{SyncModule:()=>Qt});var T=a(177),S=a(6489),d=a(9417),b=a(9510),R=a(4527),u=a(6697),t=a(4438),C=a(3606),x=a(3085),O=a(6010),v=a(3955);function N(i,o){if(1&i){const e=t.RV6();t.j41(0,"div",5)(1,"span"),t.EFF(2),t.nI1(3,"translate"),t.k0s(),t.j41(4,"pa-button",7),t.bIt("click",function(){t.eBV(e);const s=t.XpG();return t.Njj(s.setDefaultLocal())}),t.EFF(5),t.nI1(6,"translate"),t.k0s()()}2&i&&(t.R7$(2),t.JRh(t.bMT(3,2,"upload.server.help-local")),t.R7$(3),t.SpI(" ",t.bMT(6,4,"upload.server.set-local")," "))}let A=(()=>{class i{constructor(e,n,s){this.sync=e,this.navigationService=n,this.router=s,this.localUrl=b.Ql,this.serverUrl=new d.MJ(localStorage.getItem(b.mY)||"",{nonNullable:!0})}save(){this.sync.setSyncServer(this.serverUrl.value),this.back()}back(){this.navigationService.kbUrl.pipe((0,u.s)(1)).subscribe(e=>this.router.navigate([`${e}/upload`]))}setDefaultLocal(){this.serverUrl.setValue(this.localUrl),this.serverUrl.markAsDirty()}static#t=this.\u0275fac=function(n){return new(n||i)(t.rXU(b.HJ),t.rXU(R.o_),t.rXU(S.Ix))};static#e=this.\u0275cmp=t.VBU({type:i,selectors:[["nsy-server-setup"]],decls:18,vars:21,consts:[[1,"header"],["icon","chevron-left","aspect","basic",3,"click","paTooltip"],[1,"container"],[3,"innerHTML"],["placeholder","https://my.sync.server",3,"formControl"],[1,"local"],["kind","primary",1,"save-button",3,"click","disabled"],["size","small","aspect","basic",3,"click"]],template:function(n,s){1&n&&(t.j41(0,"div",0)(1,"pa-button",1),t.nI1(2,"translate"),t.bIt("click",function(){return s.back()}),t.EFF(3),t.nI1(4,"translate"),t.k0s(),t.j41(5,"h1"),t.EFF(6),t.nI1(7,"translate"),t.k0s()(),t.j41(8,"div",2),t.nrm(9,"p",3),t.nI1(10,"translate"),t.j41(11,"pa-input",4),t.EFF(12),t.nI1(13,"translate"),t.k0s(),t.DNE(14,N,7,6,"div",5),t.j41(15,"pa-button",6),t.bIt("click",function(){return s.save()}),t.EFF(16),t.nI1(17,"translate"),t.k0s()()),2&n&&(t.R7$(),t.Y8G("paTooltip",t.bMT(2,9,"upload.server.back")),t.R7$(2),t.SpI(" ",t.bMT(4,11,"upload.server.back")," "),t.R7$(3),t.JRh(t.bMT(7,13,"upload.server.title")),t.R7$(3),t.Y8G("innerHTML",t.bMT(10,15,"upload.server.description"),t.npT),t.R7$(2),t.Y8G("formControl",s.serverUrl),t.R7$(),t.SpI(" ",t.bMT(13,17,"upload.server.url")," "),t.R7$(2),t.vxM(14,s.serverUrl.value!==s.localUrl?14:-1),t.R7$(),t.Y8G("disabled",s.serverUrl.pristine),t.R7$(),t.SpI(" ",t.bMT(17,19,"generic.save")," "))},dependencies:[C.Q,x.S,O.d,d.BC,d.l_,v.D9],styles:['@charset "UTF-8";.header[_ngcontent-%COMP%]{display:flex}p[_ngcontent-%COMP%]{margin-bottom:2rem}.container[_ngcontent-%COMP%]{max-width:40rem}.save-button[_ngcontent-%COMP%]{margin-top:1.5rem}.local[_ngcontent-%COMP%]{margin-top:1rem}.local[_ngcontent-%COMP%]   pa-button[_ngcontent-%COMP%]{margin-left:1rem}'],changeDetection:0})}return i})();var p=a(5558),f=a(6354),$=a(1413),I=a(5964),D=a(6977),y=a(2827),G=a(4899),P=a(7725),B=a(3515),E=a(8141),Y=a(9172),M=a(7673),w=a(7469),U=a(9437),J=a(4929),L=a(5472),Q=a(9435),z=a(3107),H=a(2885),W=a(4684);const Z=(i,o)=>o.index;function K(i,o){if(1&i){const e=t.RV6();t.j41(0,"div",2),t.nrm(1,"pa-icon",4),t.j41(2,"div",5),t.EFF(3),t.nI1(4,"translate"),t.j41(5,"pa-button",6),t.bIt("click",function(){t.eBV(e);const s=t.XpG(2);return t.Njj(s.goTo.emit("folders"))}),t.EFF(6),t.nI1(7,"translate"),t.k0s()()()}2&i&&(t.R7$(3),t.SpI(" ",t.bMT(4,2,"upload.activity.no-folders")," "),t.R7$(3),t.SpI(" ",t.bMT(7,4,"upload.activity.select-folder")," "))}function q(i,o){if(1&i){const e=t.RV6();t.j41(0,"p"),t.EFF(1),t.nI1(2,"translate"),t.k0s(),t.DNE(3,K,8,6,"div",2),t.nI1(4,"async"),t.nI1(5,"async"),t.j41(6,"pa-button",3),t.nI1(7,"async"),t.nI1(8,"async"),t.bIt("click",function(){t.eBV(e);const s=t.XpG();return t.Njj(s.triggerSync())}),t.EFF(9),t.nI1(10,"translate"),t.k0s()}if(2&i){const e=t.XpG();t.R7$(),t.JRh(t.bMT(2,4,"upload.activity.help")),t.R7$(2),t.vxM(3,t.bMT(4,6,e.canSelectFiles)&&t.bMT(5,8,e.noFolderSelected)?3:-1),t.R7$(3),t.Y8G("disabled",e.syncing||t.bMT(7,10,e.canSelectFiles)&&t.bMT(8,12,e.noFolderSelected)),t.R7$(3),t.SpI(" ",t.bMT(10,14,"upload.activity.sync-now")," ")}}function tt(i,o){if(1&i&&(t.j41(0,"pa-table-row")(1,"pa-table-cell"),t.nrm(2,"pa-icon",7),t.k0s(),t.j41(3,"pa-table-cell"),t.nrm(4,"pa-datetime",8),t.k0s(),t.j41(5,"pa-table-cell"),t.EFF(6),t.k0s()()),2&i){const e=o.$implicit;t.R7$(2),t.Y8G("name",e.icon),t.R7$(2),t.Y8G("datetime",e.date),t.R7$(2),t.JRh(e.message)}}let et=(()=>{class i{constructor(e,n,s,c){this.syncService=e,this.cdr=n,this.router=s,this.toast=c,this.goTo=new t.bkB,this.unsubscribeAll=new $.B,this.since="",this.currentIndex=0,this.logs=[],this.syncing=!1,this.currentSync=this.syncService.getCurrentSync(),this.canSelectFiles=this.syncService.currentSourceId.pipe((0,f.T)(r=>this.syncService.canSelectFiles(r||""))),this.noFolderSelected=this.currentSync.pipe((0,f.T)(r=>!r.foldersToSync||0===r.foldersToSync.length)),this.disabled=this.currentSync.pipe((0,f.T)(r=>!!r.disabled))}ngOnInit(){this.router.events.pipe((0,I.p)(e=>e instanceof S.wF),(0,E.M)(()=>{this.since="",this.logs=[],this.cdr.markForCheck()}),(0,Y.Z)(null),(0,p.n)(()=>this.syncService.currentSourceId),(0,I.p)(e=>!!e),(0,p.n)(e=>(0,M.of)(e).pipe((0,w.u)({delay:1e4}))),(0,p.n)(e=>this.syncService.getLogs(e,this.since).pipe((0,U.W)(n=>(console.error("Error while fetching logs",n),(0,M.of)([]))))),(0,f.T)(e=>e.map((n,s)=>({index:s+this.currentIndex,date:n.createdAt,message:n.message,icon:"high"===n.level?"circle-cross":"medium"===n.level?"warning":"circle-check"}))),(0,D.Q)(this.unsubscribeAll)).subscribe(e=>{this.since=e[0]?.date||this.since,this.currentIndex+=e.length,this.logs=e.concat(this.logs),this.cdr.markForCheck()})}ngOnDestroy(){this.unsubscribeAll.next(),this.unsubscribeAll.complete()}triggerSync(){this.syncing=!0,this.cdr.markForCheck(),this.syncService.triggerSyncs().subscribe({complete:()=>{this.syncing=!1,this.cdr.markForCheck()},error:()=>{this.toast.error("upload.activity.error"),this.syncing=!1,this.cdr.markForCheck()}})}static#t=this.\u0275fac=function(n){return new(n||i)(t.rXU(b.HJ),t.rXU(t.gRc),t.rXU(S.Ix),t.rXU(y._g))};static#e=this.\u0275cmp=t.VBU({type:i,selectors:[["nsy-activity"]],outputs:{goTo:"goTo"},decls:13,vars:9,consts:[["columns","48px 200px auto"],["header",""],[1,"warning-container"],[3,"click","disabled"],["name","warning"],[1,"title-xxs"],["aspect","basic","size","small",3,"click"],[3,"name"],[3,"datetime"]],template:function(n,s){1&n&&(t.DNE(0,q,11,16),t.nI1(1,"async"),t.j41(2,"pa-table",0)(3,"pa-table-header"),t.nrm(4,"pa-table-cell",1),t.j41(5,"pa-table-cell",1),t.EFF(6),t.nI1(7,"translate"),t.k0s(),t.j41(8,"pa-table-cell",1),t.EFF(9),t.nI1(10,"translate"),t.k0s()(),t.Z7z(11,tt,7,3,"pa-table-row",null,Z),t.k0s()),2&n&&(t.vxM(0,!1===t.bMT(1,3,s.disabled)?0:-1),t.R7$(6),t.JRh(t.bMT(7,5,"upload.activity.date")),t.R7$(3),t.JRh(t.bMT(10,7,"upload.activity.event")),t.R7$(2),t.Dyx(s.logs))},dependencies:[C.Q,J.R,L.O,Q.e,z.U,H.Bz,W.Z,T.Jj,v.D9],styles:['@charset "UTF-8";.warning-container[_ngcontent-%COMP%]{display:flex;align-items:center;background:#ffdd1a;color:#000;margin-bottom:1rem;padding:1rem;gap:1rem}'],changeDetection:0})}return i})();var V=a(5119);const nt=(i,o)=>o.id;function it(i,o){if(1&i&&(t.j41(0,"pa-input",6),t.nI1(1,"translate"),t.EFF(2),t.nI1(3,"translate"),t.k0s()),2&i){const e=t.XpG().$implicit;t.Y8G("help",e.help?t.bMT(1,4,e.help):void 0)("placeholder",e.placeholder)("formControlName",e.id),t.R7$(2),t.SpI(" ",t.bMT(3,6,e.label)," ")}}function st(i,o){if(1&i&&(t.j41(0,"pa-textarea",7),t.nI1(1,"translate"),t.EFF(2),t.nI1(3,"translate"),t.k0s()),2&i){const e=t.XpG().$implicit;t.Y8G("help",e.help?t.bMT(1,3,e.help):void 0)("formControlName",e.id),t.R7$(2),t.SpI(" ",t.bMT(3,5,e.label)," ")}}function ot(i,o){if(1&i&&(t.j41(0,"div",3),t.DNE(1,it,4,8,"pa-input",6)(2,st,4,7,"pa-textarea",7),t.k0s()),2&i){const e=o.$implicit;t.R7$(),t.vxM(1,"text"===e.type?1:-1),t.R7$(),t.vxM(2,"textarea"===e.type?2:-1)}}function ct(i,o){1&i&&(t.j41(0,"pa-toggle",4),t.nI1(1,"translate"),t.EFF(2),t.nI1(3,"translate"),t.k0s()),2&i&&(t.Y8G("help",t.bMT(1,2,"upload.sync.security-groups.help")),t.R7$(2),t.SpI(" ",t.bMT(3,4,"upload.sync.security-groups.label")," "))}function rt(i,o){if(1&i){const e=t.RV6();t.j41(0,"form",1),t.bIt("ngSubmit",function(){t.eBV(e);const s=t.XpG();return t.Njj(s.save())}),t.j41(1,"pa-input",2),t.EFF(2),t.nI1(3,"translate"),t.k0s(),t.Z7z(4,ot,3,2,"div",3,nt),t.DNE(6,ct,4,6,"pa-toggle",4),t.j41(7,"pa-button",5),t.EFF(8),t.nI1(9,"translate"),t.k0s()()}if(2&i){const e=t.XpG();t.Y8G("formGroup",e.form),t.R7$(2),t.SpI(" ",t.bMT(3,5,"upload.source.name")," "),t.R7$(2),t.Dyx(e.fields),t.R7$(2),t.vxM(6,e.canSyncSecurityGroups?6:-1),t.R7$(),t.Y8G("disabled",!e.form.valid),t.R7$(),t.SpI(" ",t.bMT(9,7,"action.save")," ")}}let at=(()=>{class i{constructor(e,n,s,c){this.syncService=e,this.toast=n,this.formBuilder=s,this.cdr=c,this.goTo=new t.bkB,this.canSyncSecurityGroups=!1}ngOnInit(){this.syncService.getCurrentSync().pipe((0,I.p)(e=>!!e),(0,E.M)(e=>this.sync=e),(0,p.n)(e=>this.syncService.getConnector(e.connector.name,"").pipe((0,p.n)(n=>(this.canSyncSecurityGroups=n.canSyncSecurityGroups,n.getParameters())),(0,f.T)(n=>({sync:e,fields:n}))))).subscribe(({sync:e,fields:n})=>this.showFields(e,n))}save(){const e=this.sync;e&&this.syncService.getConnector(e.connector.name,"").pipe((0,p.n)(n=>{const s={...e.connector.parameters,...this.form?.value.fields||{}},c={title:this.form?.value.title||"",connector:{...e.connector,parameters:s},syncSecurityGroups:this.form?.value.syncSecurityGroups};return n.allowToSelectFolders||("function"==typeof n.handleParameters&&n.handleParameters(s),c.foldersToSync=n.getStaticFolders()),this.syncService.updateSync(e.id,c)})).subscribe({next:()=>{this.toast.success("upload.saved"),this.goTo.emit("activity")},error:()=>{this.toast.error("upload.failed")}})}showFields(e,n){this.fields=n,this.form=this.formBuilder.group({title:["",d.k0.required],syncSecurityGroups:[!1],fields:this.formBuilder.group(n.reduce((s,c)=>({...s,[c.id]:["",this.getFieldValidators(c)]}),{}))}),this.form.patchValue({fields:e.connector.parameters,title:e.title||e.id,syncSecurityGroups:e.syncSecurityGroups||!1}),this.cdr.markForCheck()}getFieldValidators(e){const n=[];return e.required&&n.push(d.k0.required),e.pattern&&n.push(d.k0.pattern(e.pattern)),n}static#t=this.\u0275fac=function(n){return new(n||i)(t.rXU(b.HJ),t.rXU(y._g),t.rXU(d.ze),t.rXU(t.gRc))};static#e=this.\u0275cmp=t.VBU({type:i,selectors:[["nsy-edit-settings"]],outputs:{goTo:"goTo"},decls:1,vars:1,consts:[["qa","fields-form",3,"formGroup"],["qa","fields-form",3,"ngSubmit","formGroup"],["formControlName","title"],["formGroupName","fields",1,"field"],["formControlName","syncSecurityGroups","labelOnRight","",3,"help"],["qa","save-button","type","submit",3,"disabled"],[3,"help","placeholder","formControlName"],[3,"help","formControlName"]],template:function(n,s){1&n&&t.DNE(0,rt,10,9,"form",0),2&n&&t.vxM(0,s.fields&&s.form?0:-1)},dependencies:[d.qT,d.BC,d.cb,d.j4,d.JD,d.$R,x.S,V.Q,C.Q,G.a,v.D9],styles:['@charset "UTF-8";.field[_ngcontent-%COMP%]{margin:1rem 0}.field[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;margin-bottom:.5rem}pa-button[_ngcontent-%COMP%]{margin-top:1rem}'],changeDetection:0})}return i})();var lt=a(1943),dt=a(7647),pt=a(7468);a(4402);class mt{get selected(){return this._selected||(this._selected=Array.from(this._selection.values())),this._selected}constructor(o=!1,e,n=!0,s){this._multiple=o,this._emitChanges=n,this.compareWith=s,this._selection=new Set,this._deselectedToEmit=[],this._selectedToEmit=[],this.changed=new $.B,e&&e.length&&(o?e.forEach(c=>this._markSelected(c)):this._markSelected(e[0]),this._selectedToEmit.length=0)}select(...o){this._verifyValueAssignment(o),o.forEach(n=>this._markSelected(n));const e=this._hasQueuedChanges();return this._emitChangeEvent(),e}deselect(...o){this._verifyValueAssignment(o),o.forEach(n=>this._unmarkSelected(n));const e=this._hasQueuedChanges();return this._emitChangeEvent(),e}setSelection(...o){this._verifyValueAssignment(o);const e=this.selected,n=new Set(o);o.forEach(c=>this._markSelected(c)),e.filter(c=>!n.has(this._getConcreteValue(c,n))).forEach(c=>this._unmarkSelected(c));const s=this._hasQueuedChanges();return this._emitChangeEvent(),s}toggle(o){return this.isSelected(o)?this.deselect(o):this.select(o)}clear(o=!0){this._unmarkAll();const e=this._hasQueuedChanges();return o&&this._emitChangeEvent(),e}isSelected(o){return this._selection.has(this._getConcreteValue(o))}isEmpty(){return 0===this._selection.size}hasValue(){return!this.isEmpty()}sort(o){this._multiple&&this.selected&&this._selected.sort(o)}isMultipleSelection(){return this._multiple}_emitChangeEvent(){this._selected=null,(this._selectedToEmit.length||this._deselectedToEmit.length)&&(this.changed.next({source:this,added:this._selectedToEmit,removed:this._deselectedToEmit}),this._deselectedToEmit=[],this._selectedToEmit=[])}_markSelected(o){o=this._getConcreteValue(o),this.isSelected(o)||(this._multiple||this._unmarkAll(),this.isSelected(o)||this._selection.add(o),this._emitChanges&&this._selectedToEmit.push(o))}_unmarkSelected(o){o=this._getConcreteValue(o),this.isSelected(o)&&(this._selection.delete(o),this._emitChanges&&this._deselectedToEmit.push(o))}_unmarkAll(){this.isEmpty()||this._selection.forEach(o=>this._unmarkSelected(o))}_verifyValueAssignment(o){}_hasQueuedChanges(){return!(!this._deselectedToEmit.length&&!this._selectedToEmit.length)}_getConcreteValue(o,e){if(this.compareWith){e=e??this._selection;for(let n of e)if(this.compareWith(o,n))return n;return o}return o}}var X=a(913),ft=a(7670);const gt=(i,o)=>o.uuid;function St(i,o){if(1&i&&(t.j41(0,"span",4),t.EFF(1),t.k0s()),2&i){const e=t.XpG().$implicit;t.R7$(),t.JRh(e.metadata.path)}}function yt(i,o){if(1&i){const e=t.RV6();t.j41(0,"tr")(1,"td")(2,"pa-checkbox",3),t.bIt("valueChange",function(){const s=t.eBV(e).$implicit,c=t.XpG();return t.Njj(c.toggle(s))}),t.DNE(3,St,2,1,"span",4),t.EFF(4),t.k0s()()()}if(2&i){const e=o.$implicit,n=t.XpG();t.R7$(2),t.Y8G("value",n.selection.isSelected(e)),t.R7$(),t.vxM(3,e.metadata.path?3:-1),t.R7$(),t.SpI(" ",e.title," ")}}function _t(i,o){1&i&&t.nrm(0,"nsi-spinner")}const bt=/\//g;let vt=(()=>{class i{constructor(e,n,s){this.syncService=e,this.toast=n,this.cdr=s,this.goTo=new t.bkB,this.loading=!1,this.query="",this.selection=new mt(!0,[]),this.triggerSearch=new $.B,this.canSelectFiles=this.syncService.currentSourceId.pipe((0,f.T)(c=>this.syncService.canSelectFiles(c||""))),this.resources=this.triggerSearch.pipe((0,E.M)(()=>{this.loading=!0,this.cdr.markForCheck()}),(0,p.n)(()=>this.syncService.getFolders(this.query).pipe((0,U.W)(c=>(c&&this.toast.error("string"==typeof c?c:c.error?.message||c.error||c.message||"An error occurred"),(0,M.of)({items:[],nextPage:void 0})))).pipe((0,E.M)(()=>{this.loading=!1,this.cdr.markForCheck()}),(0,lt.S)((c,r)=>c.concat(r.items),[]))),(0,f.T)(c=>c.map(r=>{let l=r.metadata.path;return l?(l.startsWith("/")||(l=`/${l}`),l+="/",l=l.replace(bt," / ")):l="/",{...r,metadata:{...r.metadata||{},path:l}}}).sort((r,l)=>("/"===r.metadata.path?` / ${r.title}`:`${r.metadata.path} / ${r.title}`).localeCompare("/"===l.metadata.path?` / ${l.title}`:`${l.metadata.path} / ${l.title}`))),(0,dt.u)())}ngOnInit(){(0,pt.p)([this.syncService.getCurrentSync().pipe((0,u.s)(1)),this.resources.pipe((0,u.s)(1))]).subscribe(([e,n])=>{e.foldersToSync?.forEach(s=>{const c=n.find(r=>r.uuid===s.uuid);c&&this.selection.select(c)}),this.cdr.detectChanges()})}ngAfterViewInit(){setTimeout(()=>{this.triggerSearch.next()},200)}save(){this.syncService.currentSourceId.pipe((0,u.s)(1),(0,p.n)(e=>this.syncService.updateSync(e||"",{foldersToSync:this.selection.selected},!0))).subscribe({next:()=>{this.toast.success("upload.saved"),this.goTo.emit("activity")},error:()=>{this.toast.error("upload.failed")}})}toggle(e){this.selection.toggle(e),this.cdr.detectChanges()}static#t=this.\u0275fac=function(n){return new(n||i)(t.rXU(b.HJ),t.rXU(y._g),t.rXU(t.gRc))};static#e=this.\u0275cmp=t.VBU({type:i,selectors:[["nsy-edit-folders"]],outputs:{goTo:"goTo"},decls:10,vars:6,consts:[[1,"body"],[1,"actions"],["qa","save-button",3,"click"],[3,"valueChange","value"],[1,"body-xs"]],template:function(n,s){1&n&&(t.j41(0,"div",0)(1,"table"),t.Z7z(2,yt,5,3,"tr",null,gt),t.nI1(4,"async"),t.k0s()(),t.DNE(5,_t,1,0,"nsi-spinner"),t.j41(6,"div",1)(7,"pa-button",2),t.bIt("click",function(){return s.save()}),t.EFF(8),t.nI1(9,"translate"),t.k0s()()),2&n&&(t.R7$(2),t.Dyx(t.bMT(4,2,s.resources)),t.R7$(3),t.vxM(5,s.loading?5:-1),t.R7$(3),t.SpI(" ",t.bMT(9,4,"action.save")," "))},dependencies:[C.Q,X.P,ft.t,T.Jj,v.D9],styles:['@charset "UTF-8";.body[_ngcontent-%COMP%]{overflow-y:auto}table[_ngcontent-%COMP%]{border-spacing:0;margin-top:.5rem;width:calc(100% - 1rem)}td[_ngcontent-%COMP%]{align-items:center;border-bottom:1px solid hsl(0,0%,44%);display:flex;height:2rem;transition:color .16s ease-in-out}td[_ngcontent-%COMP%]   .disabled[_ngcontent-%COMP%]{color:#c4c4c4;padding-left:1.75rem}.parameters[_ngcontent-%COMP%], .actions[_ngcontent-%COMP%]{margin-top:2rem}'],changeDetection:0})}return i})();var Tt=a(4697),Ct=a(5424);function Ft(i,o){if(1&i){const e=t.RV6();t.j41(0,"label",0),t.EFF(1),t.nI1(2,"translate"),t.k0s(),t.j41(3,"div",1)(4,"nsi-labels-expander",2),t.nI1(5,"async"),t.bIt("updateSelection",function(s){t.eBV(e);const c=t.XpG();return t.Njj(c.updateLabelSelection(s))}),t.k0s()(),t.j41(6,"div",3)(7,"pa-button",4),t.bIt("click",function(){t.eBV(e);const s=t.XpG();return t.Njj(s.save())}),t.EFF(8),t.nI1(9,"translate"),t.k0s()()}if(2&i){const e=t.XpG();t.R7$(),t.SpI(" ",t.bMT(2,4,"upload.labels")," "),t.R7$(3),t.Y8G("labelSets",t.bMT(5,6,e.labelSets))("currentSelection",e.currentSelection),t.R7$(4),t.SpI(" ",t.bMT(9,8,"action.save")," ")}}function Et(i,o){1&i&&(t.j41(0,"div",5),t.EFF(1),t.nI1(2,"translate"),t.k0s()),2&i&&(t.R7$(),t.SpI(" ",t.bMT(2,1,"upload.no-labels")," "))}let It=(()=>{class i{constructor(e,n,s,c){this.syncService=e,this.sdk=n,this.toast=s,this.cdr=c,this.goTo=new t.bkB,this.labelSets=this.sdk.currentKb.pipe((0,u.s)(1),(0,p.n)(r=>r.getLabels()),(0,f.T)(r=>Object.entries(r).filter(([,l])=>0===l.kind.length||l.kind.includes(Tt.po.RESOURCES)).reduce((l,[m,h])=>({...l,[m]:h}),{}))),this.hasLabelSets=this.labelSets.pipe((0,f.T)(r=>Object.keys(r||{}).length>0)),this.currentSelection={},this.selectedLabels=[]}ngOnInit(){this.syncService.getCurrentSync().pipe((0,u.s)(1)).subscribe(e=>this.updateLabelSelection((e.labels||[]).reduce((n,s)=>({...n,[(0,y.ij)(s.labelset,s.label)]:!0}),{})))}save(){this.syncService.currentSourceId.pipe((0,u.s)(1),(0,p.n)(e=>this.syncService.updateSync(e||"",{labels:this.selectedLabels}))).subscribe({next:()=>{this.toast.success("upload.saved"),this.goTo.emit("activity")},error:()=>{this.toast.error("upload.failed")}})}updateLabelSelection(e){this.currentSelection=e,this.selectedLabels=(0,y.fS)(e),this.cdr.detectChanges()}static#t=this.\u0275fac=function(n){return new(n||i)(t.rXU(b.HJ),t.rXU(R.ok),t.rXU(y._g),t.rXU(t.gRc))};static#e=this.\u0275cmp=t.VBU({type:i,selectors:[["nsy-edit-labels"]],outputs:{goTo:"goTo"},decls:3,vars:3,consts:[["for","label-expander",1,"body-m"],[1,"labels-container"],["id","label-expander",3,"updateSelection","labelSets","currentSelection"],[1,"actions"],["qa","save-button",3,"click"],[1,"body-m"]],template:function(n,s){1&n&&(t.DNE(0,Ft,10,10),t.nI1(1,"async"),t.DNE(2,Et,3,3)),2&n&&t.vxM(0,t.bMT(1,1,s.hasLabelSets)?0:2)},dependencies:[C.Q,Ct.Q,T.Jj,v.D9],styles:['@charset "UTF-8";.actions[_ngcontent-%COMP%]{margin-top:2rem}'],changeDetection:0})}return i})();var Mt=a(7837);let kt=(()=>{class i{constructor(e,n,s){this.syncService=e,this.toast=n,this.cdr=s,this.goTo=new t.bkB,this.filtersForm=new d.gE({fileExtensions:new d.MJ(""),exclude:new d.MJ(!1),fromDate:new d.MJ(""),toDate:new d.MJ("")})}ngOnInit(){this.syncService.getCurrentSync().pipe((0,u.s)(1)).subscribe(e=>{this.filtersForm.setValue({fileExtensions:e.filters?.fileExtensions?.extensions||"",exclude:e.filters?.fileExtensions?.exclude||!1,fromDate:e.filters?.modified?.from||"",toDate:e.filters?.modified?.to||""}),this.cdr.markForCheck()})}save(){const e={};this.filtersForm.value.fileExtensions&&(e.fileExtensions={extensions:this.filtersForm.value.fileExtensions,exclude:!!this.filtersForm.value.exclude}),(this.filtersForm.value.fromDate||this.filtersForm.value.toDate)&&(e.modified={from:this.filtersForm.value.fromDate||void 0,to:this.filtersForm.value.toDate||void 0}),this.syncService.currentSourceId.pipe((0,u.s)(1),(0,p.n)(n=>this.syncService.updateSync(n||"",{filters:e},!0))).subscribe({next:()=>{this.toast.success("upload.saved"),this.goTo.emit("activity")},error:()=>{this.toast.error("upload.failed")}})}static#t=this.\u0275fac=function(n){return new(n||i)(t.rXU(b.HJ),t.rXU(y._g),t.rXU(t.gRc))};static#e=this.\u0275cmp=t.VBU({type:i,selectors:[["nsy-edit-filters"]],outputs:{goTo:"goTo"},decls:24,vars:19,consts:[[3,"ngSubmit","formGroup"],[1,"title-m"],[1,"field"],["formControlName","fileExtensions","help","upload.filters.extensions-help",3,"placeholder"],["help","upload.filters.exclude-help","formControlName","exclude"],["formControlName","fromDate","label","upload.filters.modified-from"],["formControlName","toDate","label","upload.filters.modified-to"],[1,"actions"],["qa","save-button",3,"click"]],template:function(n,s){1&n&&(t.j41(0,"form",0),t.bIt("ngSubmit",function(){return s.save()}),t.j41(1,"h3",1),t.EFF(2),t.nI1(3,"translate"),t.k0s(),t.j41(4,"div",2)(5,"pa-input",3),t.nI1(6,"translate"),t.EFF(7),t.nI1(8,"translate"),t.k0s()(),t.j41(9,"div",2)(10,"pa-checkbox",4),t.EFF(11),t.nI1(12,"translate"),t.k0s()(),t.j41(13,"div",2)(14,"h3",1),t.EFF(15),t.nI1(16,"translate"),t.k0s(),t.nrm(17,"pa-date-picker",5),t.k0s(),t.j41(18,"div",2),t.nrm(19,"pa-date-picker",6),t.k0s(),t.j41(20,"div",7)(21,"pa-button",8),t.bIt("click",function(){return s.save()}),t.EFF(22),t.nI1(23,"translate"),t.k0s()()()),2&n&&(t.Y8G("formGroup",s.filtersForm),t.R7$(2),t.JRh(t.bMT(3,7,"upload.filters.extensions")),t.R7$(3),t.Y8G("placeholder",t.bMT(6,9,"upload.filters.extensions-placeholder")),t.R7$(2),t.SpI(" ",t.bMT(8,11,"upload.filters.extensions")," "),t.R7$(4),t.SpI(" ",t.bMT(12,13,"upload.filters.exclude")," "),t.R7$(4),t.JRh(t.bMT(16,15,"upload.filters.modified")),t.R7$(7),t.SpI(" ",t.bMT(23,17,"action.save")," "))},dependencies:[d.qT,d.BC,d.cb,d.j4,d.JD,x.S,C.Q,X.P,Mt.I,v.D9],styles:['@charset "UTF-8";h3[_ngcontent-%COMP%], .actions[_ngcontent-%COMP%]{margin-top:2rem}.field[_ngcontent-%COMP%]{margin:1rem 0}'],changeDetection:0})}return i})();function Rt(i,o){if(1&i){const e=t.RV6();t.j41(0,"pa-tab",5),t.bIt("click",function(){t.eBV(e);const s=t.XpG();return t.Njj(s.selectedTab="folders")}),t.EFF(1),t.nI1(2,"translate"),t.k0s()}if(2&i){const e=t.XpG();t.Y8G("active","folders"===e.selectedTab),t.R7$(),t.SpI(" ",t.bMT(2,2,"upload.tabs.folders")," ")}}function xt(i,o){if(1&i){const e=t.RV6();t.j41(0,"section")(1,"nsy-activity",7),t.bIt("goTo",function(s){t.eBV(e);const c=t.XpG();return t.Njj(c.goTo(s))}),t.k0s()()}}function $t(i,o){if(1&i){const e=t.RV6();t.j41(0,"section")(1,"nsy-edit-folders",7),t.bIt("goTo",function(s){t.eBV(e);const c=t.XpG();return t.Njj(c.goTo(s))}),t.k0s()()}}function jt(i,o){if(1&i){const e=t.RV6();t.j41(0,"section")(1,"nsy-edit-filters",7),t.bIt("goTo",function(s){t.eBV(e);const c=t.XpG();return t.Njj(c.goTo(s))}),t.k0s()()}}function Dt(i,o){if(1&i){const e=t.RV6();t.j41(0,"section")(1,"nsy-edit-labels",7),t.bIt("goTo",function(s){t.eBV(e);const c=t.XpG();return t.Njj(c.goTo(s))}),t.k0s()()}}function Gt(i,o){if(1&i){const e=t.RV6();t.j41(0,"section")(1,"nsy-edit-settings",7),t.bIt("goTo",function(s){t.eBV(e);const c=t.XpG();return t.Njj(c.goTo(s))}),t.k0s()()}}let Ut=(()=>{class i{constructor(e,n,s,c,r){this.syncService=e,this.router=n,this.toast=s,this.cdr=c,this.route=r,this.currentSync=this.syncService.getCurrentSync(),this.connector=this.currentSync.pipe((0,p.n)(l=>this.syncService.connectorsObs.pipe((0,f.T)(m=>m.find(h=>h.id===l.connector.name))))),this.canSelectFiles=this.syncService.getCurrentSync().pipe((0,f.T)(l=>this.syncService.canSelectFiles(l.id||""))),this.selectedTab="activity",this.enabled=this.currentSync.pipe((0,f.T)(l=>!l.disabled)),this.unsubscribeAll=new $.B}ngOnInit(){this.route.paramMap.subscribe(e=>{this.syncService.setCurrentSourceId(e.get("id")||"")}),this.router.events.pipe((0,I.p)(e=>e instanceof S.wF),(0,f.T)(e=>e.url.split("/upload/sync/")[1]?.split("/")[0]),(0,D.Q)(this.unsubscribeAll)).subscribe(e=>{this.syncService.setCurrentSourceId(e),this.selectedTab="activity",this.cdr.markForCheck()}),this.currentSync.pipe((0,u.s)(1),(0,p.n)(e=>this.syncService.hasCurrentSourceAuth().pipe((0,I.p)(n=>!n),(0,p.n)(()=>this.syncService.getConnector(e.connector.name,e.id)),(0,p.n)(n=>this.syncService.authenticateToConnector(e.connector.name,n))))).subscribe({next:()=>{this.toast.success("upload.authentication.success"),this.router.navigate([],{queryParams:{}})},error:()=>this.toast.error("upload.authentication.failed")})}ngOnDestroy(){this.unsubscribeAll.next(),this.unsubscribeAll.complete()}delete(){this.syncService.currentSourceId.pipe((0,u.s)(1),(0,p.n)(e=>this.syncService.deleteSync(e||""))).subscribe({next:()=>{const e=this.router.url.split("/upload/")[0];this.router.navigate([`${e}/upload`])},error:()=>{this.toast.error("upload.deletion-failed")}})}goTo(e){this.selectedTab=e,this.cdr.markForCheck()}toggle(){this.currentSync.pipe((0,u.s)(1),(0,p.n)(e=>this.syncService.updateSync(e.id,{disabled:!e.disabled}))).subscribe({error:()=>{this.toast.error("upload.failed")}})}static#t=this.\u0275fac=function(n){return new(n||i)(t.rXU(b.HJ),t.rXU(S.Ix),t.rXU(y._g),t.rXU(t.gRc),t.rXU(S.nX))};static#e=this.\u0275cmp=t.VBU({type:i,selectors:[["ng-component"]],decls:33,vars:39,consts:[[1,"header"],[3,"src","alt"],[1,"actions"],[3,"click","value"],["icon","trash","aspect","basic",3,"click"],[3,"click","active"],[3,"active"],[3,"goTo"]],template:function(n,s){if(1&n&&(t.j41(0,"div",0)(1,"h2"),t.nrm(2,"img",1),t.nI1(3,"async"),t.nI1(4,"async"),t.EFF(5),t.nI1(6,"async"),t.k0s(),t.j41(7,"div",2)(8,"pa-toggle",3),t.nI1(9,"async"),t.bIt("click",function(){return s.toggle()}),t.EFF(10),t.nI1(11,"translate"),t.k0s(),t.j41(12,"pa-button",4),t.bIt("click",function(){return s.delete()}),t.k0s()()(),t.j41(13,"pa-tabs")(14,"pa-tab",5),t.bIt("click",function(){return s.selectedTab="activity"}),t.EFF(15),t.nI1(16,"translate"),t.k0s(),t.DNE(17,Rt,3,4,"pa-tab",6),t.nI1(18,"async"),t.j41(19,"pa-tab",5),t.bIt("click",function(){return s.selectedTab="filters"}),t.EFF(20),t.nI1(21,"translate"),t.k0s(),t.j41(22,"pa-tab",5),t.bIt("click",function(){return s.selectedTab="labels"}),t.EFF(23),t.nI1(24,"translate"),t.k0s(),t.j41(25,"pa-tab",5),t.bIt("click",function(){return s.selectedTab="settings"}),t.EFF(26),t.nI1(27,"translate"),t.k0s()(),t.DNE(28,xt,2,0,"section")(29,$t,2,0,"section")(30,jt,2,0,"section")(31,Dt,2,0,"section")(32,Gt,2,0,"section")),2&n){let c,r,l;t.R7$(2),t.Y8G("src",null==(c=t.bMT(3,19,s.connector))?null:c.logo,t.B4B)("alt",(null==(r=t.bMT(4,21,s.connector))?null:r.title)+" logo"),t.R7$(3),t.SpI(" ",null==(l=t.bMT(6,23,s.currentSync))?null:l.title," "),t.R7$(3),t.Y8G("value",t.bMT(9,25,s.enabled)),t.R7$(2),t.SpI(" ",t.bMT(11,27,"upload.active")," "),t.R7$(4),t.Y8G("active","activity"===s.selectedTab),t.R7$(),t.SpI(" ",t.bMT(16,29,"upload.tabs.activity")," "),t.R7$(2),t.vxM(17,t.bMT(18,31,s.canSelectFiles)?17:-1),t.R7$(2),t.Y8G("active","filters"===s.selectedTab),t.R7$(),t.SpI(" ",t.bMT(21,33,"upload.tabs.filters")," "),t.R7$(2),t.Y8G("active","labels"===s.selectedTab),t.R7$(),t.SpI(" ",t.bMT(24,35,"upload.tabs.labels")," "),t.R7$(2),t.Y8G("active","settings"===s.selectedTab),t.R7$(),t.SpI(" ",t.bMT(27,37,"upload.tabs.settings")," "),t.R7$(2),t.vxM(28,"activity"===s.selectedTab?28:-1),t.R7$(),t.vxM(29,"folders"===s.selectedTab?29:-1),t.R7$(),t.vxM(30,"filters"===s.selectedTab?30:-1),t.R7$(),t.vxM(31,"labels"===s.selectedTab?31:-1),t.R7$(),t.vxM(32,"settings"===s.selectedTab?32:-1)}},dependencies:[C.Q,G.a,P.Q,B.w,et,at,vt,It,kt,T.Jj,v.D9],styles:['@charset "UTF-8";.header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;margin-bottom:1rem}h2[_ngcontent-%COMP%]{display:flex}h2[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{height:2rem;margin-right:1rem}section[_ngcontent-%COMP%]{margin-top:2rem}.actions[_ngcontent-%COMP%]{align-items:center;display:flex;gap:1rem}'],changeDetection:0})}return i})();const Vt=(i,o)=>o.id;function Xt(i,o){if(1&i&&(t.j41(0,"pa-input",7),t.nI1(1,"translate"),t.EFF(2),t.nI1(3,"translate"),t.k0s()),2&i){const e=t.XpG().$implicit;t.Y8G("help",e.help?t.bMT(1,4,e.help):void 0)("placeholder",e.placeholder)("formControlName",e.id),t.R7$(2),t.SpI(" ",t.bMT(3,6,e.label)," ")}}function Ot(i,o){if(1&i&&(t.j41(0,"pa-textarea",8),t.nI1(1,"translate"),t.EFF(2),t.nI1(3,"translate"),t.k0s()),2&i){const e=t.XpG().$implicit;t.Y8G("help",e.help?t.bMT(1,3,e.help):void 0)("formControlName",e.id),t.R7$(2),t.SpI(" ",t.bMT(3,5,e.label)," ")}}function Nt(i,o){if(1&i&&(t.j41(0,"div",5),t.DNE(1,Xt,4,8,"pa-input",7)(2,Ot,4,7,"pa-textarea",8),t.k0s()),2&i){const e=o.$implicit;t.R7$(),t.vxM(1,"text"===e.type?1:-1),t.R7$(),t.vxM(2,"textarea"===e.type?2:-1)}}function At(i,o){if(1&i){const e=t.RV6();t.j41(0,"form",2),t.bIt("ngSubmit",function(){t.eBV(e);const s=t.XpG();return t.Njj(s.save())}),t.j41(1,"div",3)(2,"pa-input",4),t.EFF(3),t.nI1(4,"translate"),t.k0s()(),t.Z7z(5,Nt,3,2,"div",5,Vt),t.j41(7,"pa-button",6),t.EFF(8),t.nI1(9,"translate"),t.k0s()()}if(2&i){const e=t.XpG();t.Y8G("formGroup",e.form),t.R7$(3),t.SpI(" ",t.bMT(4,4,"upload.source.name")," "),t.R7$(2),t.Dyx(e.fields),t.R7$(2),t.Y8G("disabled",!e.form.valid),t.R7$(),t.SpI(" ",t.bMT(9,6,"action.save")," ")}}const Pt=new RegExp(/[^a-z0-9_-]/g),Bt=[{path:"",children:[{path:"setup/server",component:A},{path:"add/:connector",component:(()=>{class i{constructor(e,n,s,c,r,l,m){this.syncService=e,this.toast=n,this.formBuilder=s,this.cdr=c,this.router=r,this.route=l,this.sdk=m,this.connectorId=(this.sdk.nuclia.options.standalone?location.hash:location.pathname).split("/upload/sync/add/")[1]||"",this.connector=this.syncService.connectorsObs.pipe((0,f.T)(h=>h.find(_=>_.id===this.connectorId)))}ngOnInit(){this.syncService.getConnector(this.connectorId,"").pipe((0,u.s)(1),(0,p.n)(e=>e.getParameters())).subscribe(e=>this.showFields(e))}save(){const e=this.form?.value.title,n=this.form?.value.fields;let s=e?.toLowerCase().replace(Pt,"-");this.sdk.currentKb.pipe((0,u.s)(1),(0,p.n)(c=>(s=`${c.id}-${s}`,this.syncService.addSync({id:s,connector:{name:this.connectorId||"",parameters:n},title:e}))),(0,E.M)(()=>this.syncService.setCurrentSourceId(s)),(0,p.n)(()=>this.syncService.getConnector(this.connectorId,s).pipe((0,u.s)(1))),(0,p.n)(c=>c.allowToSelectFolders?(0,M.of)(c):("function"==typeof c.handleParameters&&c.handleParameters(n),this.syncService.updateSync(s,{foldersToSync:c.getStaticFolders()}).pipe((0,p.n)(()=>this.syncService.getConnector(this.connectorId,s).pipe((0,u.s)(1)))))),(0,E.M)(c=>{if(c.hasServerSideAuth){let r=location.href.split("/upload/sync/add/")[0];this.sdk.nuclia.options.standalone&&(r=r.replace("#/","")),c.goToOAuth(`${r}/upload/sync/${s}`,!0)}else this.router.navigate([`../../${s}`],{relativeTo:this.route})})).subscribe({next:()=>{this.toast.success("upload.saved")},error:c=>{console.warn(c),this.toast.error("upload.failed")}})}showFields(e){this.fields=e,this.form=this.formBuilder.group({title:["",[d.k0.required]],fields:this.formBuilder.group(e.reduce((n,s)=>({...n,[s.id]:["",this.getFieldValidators(s)]}),{}))}),this.cdr.markForCheck()}getFieldValidators(e){const n=[];return e.required&&n.push(d.k0.required),e.pattern&&n.push(d.k0.pattern(e.pattern)),n}static#t=this.\u0275fac=function(n){return new(n||i)(t.rXU(b.HJ),t.rXU(y._g),t.rXU(d.ze),t.rXU(t.gRc),t.rXU(S.Ix),t.rXU(S.nX),t.rXU(R.ok))};static#e=this.\u0275cmp=t.VBU({type:i,selectors:[["ng-component"]],decls:7,vars:10,consts:[[3,"src","alt"],["qa","fields-form",3,"formGroup"],["qa","fields-form",3,"ngSubmit","formGroup"],[1,"field"],["formControlName","title"],["formGroupName","fields",1,"field"],["qa","save-button","type","submit",3,"disabled"],[3,"help","placeholder","formControlName"],[3,"help","formControlName"]],template:function(n,s){if(1&n&&(t.j41(0,"h2"),t.nrm(1,"img",0),t.nI1(2,"async"),t.nI1(3,"async"),t.EFF(4),t.nI1(5,"async"),t.k0s(),t.DNE(6,At,10,8,"form",1)),2&n){let c,r,l;t.R7$(),t.Y8G("src",null==(c=t.bMT(2,4,s.connector))?null:c.logo,t.B4B)("alt",(null==(r=t.bMT(3,6,s.connector))?null:r.title)+" logo"),t.R7$(3),t.SpI(" ",null==(l=t.bMT(5,8,s.connector))?null:l.title,"\n"),t.R7$(2),t.vxM(6,s.fields&&s.form?6:-1)}},dependencies:[d.qT,d.BC,d.cb,d.j4,d.JD,d.$R,x.S,V.Q,C.Q,T.Jj,v.D9],styles:['@charset "UTF-8";h2[_ngcontent-%COMP%]{display:flex}h2[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{height:2rem;margin-right:1rem}.field[_ngcontent-%COMP%]{margin:1rem 0}.field[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;margin-bottom:.5rem}'],changeDetection:0})}return i})()},{path:":id",component:Ut}]}];let Yt=(()=>{class i{static#t=this.\u0275fac=function(n){return new(n||i)};static#e=this.\u0275mod=t.$C({type:i});static#n=this.\u0275inj=t.G2t({imports:[S.iI.forChild(Bt),S.iI]})}return i})();var wt=a(5266),g=a(2716);let Jt=(()=>{class i{static#t=this.\u0275fac=function(n){return new(n||i)};static#e=this.\u0275mod=t.$C({type:i});static#n=this.\u0275inj=t.G2t({imports:[S.iI,T.MD,v.h,wt.P,d.YN,d.X1,g.Xg,g.Ym,g.rk,g.tm,g.V3,y.J4,R.Bo,y.QB,g.aT,g.EG,g.P,g.OY]})}return i})(),Lt=(()=>{class i{static#t=this.\u0275fac=function(n){return new(n||i)};static#e=this.\u0275mod=t.$C({type:i});static#n=this.\u0275inj=t.G2t({imports:[T.MD,v.h,g.Ym,g.Xg,g.tm,d.X1]})}return i})(),Qt=(()=>{class i{static#t=this.\u0275fac=function(n){return new(n||i)};static#e=this.\u0275mod=t.$C({type:i});static#n=this.\u0275inj=t.G2t({imports:[T.MD,Yt,Jt,Lt]})}return i})()}}]);