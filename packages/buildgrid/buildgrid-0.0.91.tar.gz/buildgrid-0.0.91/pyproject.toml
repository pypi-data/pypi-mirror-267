# Copyright (C) 2023 Bloomberg LP
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#  <http://www.apache.org/licenses/LICENSE-2.0>
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

[build-system]
requires = [
    "setuptools >= 44",
    "wheel >= 0.35",
]
build-backend = 'setuptools.build_meta'

[project]
name = "buildgrid"
version = "0.0.91"
requires-python = ">=3.8"
description = "A remote execution service"
readme = "README.rst"
license = {text = "Apache License, Version 2.0"}
classifiers = [
    "Programming Language :: Python :: 3",
]
dependencies = [
    "boto3",
    "botocore",
    "dnspython",
    "grpcio-reflection >= 1.62.0",
    "grpcio >= 1.62.0",
    "janus >= 0.6.2",
    "jinja2 == 3.0.3",
    "protobuf < 4.24.0", # https://github.com/protocolbuffers/protobuf/issues/13485 # TODO: remove this once it's fixed!
    "alembic",
    "Click",
    "SQLAlchemy[mypy] >= 1.4.24, < 2.0", # For _ConnectionFairy.dbapi_connection
    "pydantic > 2.0", # required by new models in metering-client
    "PyYAML >= 6.0.1", # https://github.com/yaml/pyyaml/issues/724 cython issue in 6.0.0
    "jsonschema >= 3.0.0",
    "lark-parser",
    "pycurl",
    "buildgrid-metering-client >= 0.0.4",
    "mmh3",
]

[project.optional-dependencies]
auth = [
    "cryptography",  # Required by pyjwt for RSA
    "PyJWT",
    "requests",
]
browser = [
    "aiofiles",
    "aiohttp",
    "aiohttp-middlewares",
]
database = [
    "psycopg2-binary",
]
redis = [
    "fakeredis >= 2.10.1",
    "redis >= 4.5.1",
    "hiredis",  # Faster parsing of redis response.
]
docs = [
    "Sphinx < 7",  # Sphinx 7 removes support for `setup.py build_sphinx`, which CI still requires
    "sphinx-click",
    "sphinx-rtd-theme",
    "sphinxcontrib-apidoc",
    "sphinxcontrib-napoleon",
]
tests = [
    "coverage",
    "cryptography >= 38.0.0",  # For compatibility with pyopenssl>=22.0.0 https://github.com/pyca/pyopenssl/issues/1143
    "flaky",  # until we pin down why the bots tests are so painful.
    "flask",
    "flask-cors",
    # 4.1.12 breaks tests using S3 with 400/403. No obvious reasons can be found from the CHANGELOG / open issues yet.
    # TODO: investigate the root cause and unpin moto
    "moto < 4.1.12",
    "psutil",
    "pycodestyle",
    "pyopenssl >= 22.0.0",  # For compatibility with cryptography>=38.0.0 https://github.com/pyca/pyopenssl/issues/1143
    "pytest",
    "pytest-aiohttp",
    "pytest-asyncio",
    "pytest-cov",
    "pytest-forked",
    "pytest-pycodestyle",
    "pytest-xdist",
    "fakeredis >= 2.10.1",
    "redis >= 4.5.1",
    "testing.postgresql",
    "psycopg2-binary",
]
dev = [
    # Style
    "flake8",
    "pycodestyle",

    # Testing
    "pytest",
    "pytest-cov",
    "pytest-forked",
    "pytest-pycodestyle",
    "pytest-xdist",

    # Dependency management
    "pip-tools",

    # Memory profiling
    "memray",
]
mypy = [
    "mypy",
    "grpc-stubs >= 1.53",  # Stub only package, should be compatible with CI.
    "boto3-stubs",
    "mypy-boto3-s3",
    "sqlalchemy2-stubs <= 0.0.2a22", # For _ConnectionFairy.dbapi_connection issue caused by 0.0.2.a23
]
all = [
    # Use recursive dependencies to group other setups.
    "buildgrid[auth,browser,database,redis,docs,tests,mypy,dev]"
]

[tool.setuptools]
# See https://stackoverflow.com/questions/72294299/multiple-top-level-packages-discovered-in-a-flat-layout
py-modules = []

[project.scripts]
bgd = "buildgrid._app:cli"

[project.urls]
Homepage = "https://buildgrid.build"
Documentation = "https://buildgrid.build"
Repository = "https://gitlab.com/BuildGrid/buildgrid"

[tool.black]
line-length = 119
extend-exclude = "(buildgrid/_protos)"

[tool.isort]
line_length = 119
multi_line_output = 3
include_trailing_comma = true
use_parentheses = true
extend_skip_glob = ["buildgrid/_protos/*"]
ensure_newline_before_comments = true

sections = "FUTURE,STDLIB,THIRDPARTY,FIRSTPARTY,LOCALFOLDER"
