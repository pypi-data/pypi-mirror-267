!function(){var i,t,n,s;window.PowerPack=window.PowerPack||{},PowerPack.Utils={spaceless:function(e){for(var i=0;i<e.length;i++)e[i]=e[i].trim();return e.join("")}},PowerPack.PDF={},PowerPack.PDF.PDF=Backbone.Model.extend({defaults:{currentPage:null,numPages:null,outlineMap:null,pdfURL:"",pdfDocument:null},initialize:function(){var i=this;pdfjsLib.getDocument(this.get("pdfURL")).promise.then(function(e){i.set({currentPage:1,numPages:e.numPages,pdfDocument:e}),i._initializeNavigationMap(e)})},getDocument:function(){var n=this;return new Promise(function(t,e){var i=n.get("pdfDocument");null!==i?t(i):n.once("change:pdfDocument",function(e,i){return t(i)})})},getPage:function(i){return this.getDocument().then(function(e){return e.getPage(i)})},_initializeNavigationMap:function(e){for(var l=this,s=e.numPages,i=[],t=1;t<=s;t++)i.push(e.getPage(t));var n=Promise.all(i),o=(n.then(function(e){console.assert(e.length===s);for(var i={},t=0;t<s;t++){var n=e[t].ref;i["".concat(n.gen,"@").concat(n.num)]=t+1}l._pageMap=i}),e.getOutline()),a=e.getDestinations();Promise.all([n,a,o]).then(function(e){var a=e[1],e=e[2];l.set("outlineMap",e&&function e(i){for(var t=[],n=0;n<i.length;n++){var s=i[n].dest,o=void 0;void 0===s?console.warn("Could not find destination for outline item "+i[n].title):(void 0!==a[s]?o=a[s]:s instanceof Object&&(o=s),void 0===o?console.warn("Could not find destination for outline item "+i[n].title):(s=o[0],o="".concat(s.gen,"@").concat(s.num),t.push({title:i[n].title,page:l._pageMap[o],children:e(i[n].items)})))}return t}(e)||[])})}}),PowerPack.PDF.RegionCommentBlock=RB.RegionCommentBlock.extend({defaults:_.defaults({onDiffOrigFile:!1,page:null,scale:null,thumbnailData:null},RB.RegionCommentBlock.prototype.defaults),serializedFields:RB.RegionCommentBlock.prototype.serializedFields.concat(["onDiffOrigFile","page","thumbnailData"]),parse:function(e){return(e=RB.RegionCommentBlock.prototype.parse.call(this,e)).page=parseInt(e.page,10)||void 0,e}}),PowerPack.PDF.Reviewable=RB.FileAttachmentReviewable.extend({defaults:_.defaults({commentBlockViews:[],diffAgainstPDF:null,diffAgainstPDFURL:"",diffData:[],diffURL:"",pdf:null,pdfURL:null,scale:1,scrollLock:!1,workerURL:null},RB.FileAttachmentReviewable.prototype.defaults),commentBlockModel:PowerPack.PDF.RegionCommentBlock,initialize:function(e,i){RB.FileAttachmentReviewable.prototype.initialize.call(this,e,i),console.assert(void 0!==pdfjsLib.GlobalWorkerOptions.workerSrc,"Unable to find the pdf.js workerSrc attribute."),pdfjsLib.GlobalWorkerOptions.workerSrc=e.workerURL,this.set("pdf",new PowerPack.PDF.PDF({pdfURL:e.pdfURL})),e.diffAgainstPDFURL&&this.set("diffAgainstPDF",new PowerPack.PDF.PDF({pdfURL:e.diffAgainstPDFURL}))}}),PowerPack.PDF.Sidebar=Backbone.Model.extend({defaults:function(){return{availableModes:[PowerPack.PDF.Sidebar.MODE_THUMBNAILS],mode:PowerPack.PDF.Sidebar.MODE_THUMBNAILS,reviewable:null,visible:!1}},initialize:function(){var e=this.get("reviewable").get("pdf");this._modeIsDefault=!0,this.on("change:mode",function(e,i){this._modeIsDefault=!1},this),this.listenTo(e,"change:outlineMap",this._onOutlineChanged),this._onOutlineChanged()},_onOutlineChanged:function(){var e=[PowerPack.PDF.Sidebar.MODE_THUMBNAILS];this.get("reviewable").get("pdf").get("outlineMap")&&(e.push(PowerPack.PDF.Sidebar.MODE_OUTLINE),this._modeIsDefault)&&this.set("mode",PowerPack.PDF.Sidebar.MODE_OUTLINE),this.get("reviewable").get("diffAgainstPDF")&&e.push(PowerPack.PDF.Sidebar.MODE_DIFFS),this.set("availableModes",e)}},{MODE_COMMENTS:"comments",MODE_DIFFS:"diffs",MODE_OUTLINE:"outline",MODE_THUMBNAILS:"thumbnails"}),PowerPack.PDF.PageControlsView=Backbone.View.extend({className:"page-controls",events:{"change .pdf-page-curr":"_onChangePage","click .page-prev":"_onPrevPageClicked","click .page-next":"_onNextPageClicked"},template:_.template('<div class="pdf-page-info">\n <%- pageText %>:\n <input type="number" class="pdf-page-curr" min="1" />\n <%- ofText %>\n <span class="pdf-page-total"></span>\n</div>\n<span class="fa fa-arrow-circle-o-up page-prev"\n      title="<%- prevPageText %>"></span>\n<span class="fa fa-arrow-circle-o-down page-next"\n      title="<%- nextPageText %>"></span>'),initialize:function(){this._$currentPage=null,this._$totalPages=null},render:function(){var i,t=this,e=(this.$el.html(this.template({pageText:gettext("Page"),ofText:gettext("of"),prevPageText:gettext("Previous page"),nextPageText:gettext("Next page")})),this.model.get("pdf")),n=this.model.get("diffAgainstPDF");return this._$currentPage=this.$(".pdf-page-curr").bindProperty("value",e,"currentPage").bindProperty("max",e,"numPages"),this._$totalPages=this.$(".pdf-page-total").bindProperty("text",e,"numPages"),n&&(i=$('<input type="checkbox" id="pdf-scroll-lock">').appendTo(this.$el),$('<label for="pdf-scroll-lock">').text(gettext("Lock scroll")).appendTo(this.$el),i.on("change",function(e){t.model.set("scrollLock",i.is(":checked"))})),this},_onChangePage:function(){var e=this.model.get("pdf"),i=this._$currentPage.val();0<i&&i<=e.get("numPages")?e.set("currentPage",i):this._$currentPage.val(this.model.get("currentPage"))},_onPrevPageClicked:function(){var e=this.model.get("pdf"),i=e.get("currentPage");1<i&&e.set("currentPage",i-1)},_onNextPageClicked:function(){var e=this.model.get("pdf"),i=e.get("currentPage");i<e.get("numPages")&&e.set("currentPage",i+1)}}),PowerPack.PDF.PageRendererView=Backbone.View.extend({initialize:function(e){this._renderBusy=!1,this._scheduledRenders=[],this.pdf=e.pdf},scheduleRender:function(e,i){i=_.defaults({page:e},i);if(i.highestPriority){if(e.inRenderQueue)for(var t=0;t<this._scheduledRenders.length;t++)if(this._scheduledRenders[t].page===e){this._scheduledRenders.splice(t,1);break}this._scheduledRenders.unshift(i)}else e.inRenderQueue||this._scheduledRenders.push(i);e.inRenderQueue=!0,this._processNextRender()},_processNextRender:_.throttle(function(){var i=this;this._renderBusy||_.defer(function(){var e;0===i._scheduledRenders.length?i.trigger("renderQueueEmpty"):(e=i._scheduledRenders.shift(),i._renderPage(e,{success:function(){e.page.inRenderQueue=!1,i._processNextRender()}}))})},10),_renderPage:function(n){var s=this,l=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=n.page;r.rendered?_.isFunction(l.success)&&l.success():(this._renderBusy=!0,this.pdf.getPage(r.pageNum).then(function(e){var i=window.devicePixelRatio,t=e.getViewport({scale:1}).width,t=(n.fitToWidth?r.$el.width()/t:s.model.get("scale"))*i,o=e.getViewport({scale:t}),t={width:o.width,height:o.height},i={width:Math.round(o.width/i)+"px",height:Math.round(o.height/i)+"px"},a=(r.resize(i,t),r.rendered=!0,r.$canvas[0].getContext("2d"));e.render({canvasContext:a,viewport:o}).promise.then(function(){r.diffRegions&&r.diffRegions.forEach(function(e){var i;if("insert"===e.op)i="#dfffd7";else{if("delete"!==e.op)return;i="#ffe0e5"}var t=e.bbox[0]*o.scale,n=(e.bbox[2]-e.bbox[0])*o.scale,s=(e.bbox[3]-e.bbox[1])*o.scale,e=o.height-e.bbox[1]*o.scale-s;a.save(),a.globalCompositeOperation="multiply",a.fillStyle=i,a.fillRect(t,e,n,s),a.restore()})}).then(function(){s._renderBusy=!1,_.isFunction(l.success)&&l.success()}).catch(function(e){console.warning("Error while rendering pdf: "+e),s._renderBusy=!1,r.rendered=!1,_.isFunction(l.error)&&l.error(e)})}))}}),PowerPack.PDF.PagesView=Backbone.View.extend({className:"pdf-offset",events:{"mousedown .selection-container":"_onMouseDown",mouseup:"_onMouseUp",mousemove:"_onMouseMove",scroll:"_onScroll"},initialize:function(e){this.origFile=e.origFile,this._pageRenderer=e.pageRenderer,this._pdf=e.pdf,this._defaultPageNum=this._pdf.get("currentPage"),this._docReady=!1,this._rendered=!1,this._scrolling=!1,this._diffRegions=[],this.pages=[],_.bindAll(this,"_resizeAllPages","_resizePagesBatch")},render:function(){return this.$el.empty(),this._$pages=$('<div class="pdf-pages"/>').appendTo(this.$el),this.listenTo(this._pdf,"change:pdfDocument",this._renderDocument),this._renderDocument(this._pdf,this._pdf.get("pdfDocument")),this.listenTo(this._pdf,"change:currentPage",this._onCurrentPageChanged),this._onCurrentPageChanged(),this.listenTo(this.model,"change:scale",this._onZoomChanged),this},addDiffRegions:function(e){this._diffRegions=e,this._rendered&&(this.pages.forEach(function(i){i.setDiffRegions(e.filter(function(e){return e.page===i.pageNum-1}))}),this._renderHighestPriorityPage())},isCommentDialogVisible:function(){return this.commentDlg&&!this.commentDlg.$el.is(":hidden")},_renderDocument:function(n,e){var s=this;if(null!==e){for(var i=e.numPages,o=window.devicePixelRatio,a=this.model.get("scale"),t=0;t<i;t++)!function(i){var e=new PowerPack.PDF.PageView({diffRegions:s._diffRegions.filter(function(e){return e.page===i}),pageNum:i+1,pagesView:s});e.render().$el.appendTo(s._$pages),s.pages.push(e)}(t);return n.getPage(1).then(function(e){var e=e.getViewport({scale:a*o}),i={width:e.width,height:e.height},t={width:Math.round(e.width/o)+"px",height:Math.round(e.height/o)+"px"};s.pages.forEach(function(e){return e.resize(t,i)}),s._defaultPageNum&&n.set("currentPage",s._defaultPageNum)}),this.model.get("commentBlockViews").forEach(function(e){e.model.get("onDiffOrigFile")===s.origFile&&s.placeCommentBlockView(e.model.get("page"),e)}),this._renderHighestPriorityPage(),this._rendered=!0,this}},placeCommentBlockView:function(e,i){console.assert(e<=this.pages.length),this.pages[e-1].placeCommentBlockView(i)},_renderHighestPriorityPage:function(){var e=this._getVisiblePages(),i=_.find(e,function(e){return!e.page.rendered}),t=void 0;void 0!==(t=void 0===(t=void 0!==i?i.index:t)&&0<e.length&&(0<=(i=e[0].index-1)&&!this.pages[i].rendered&&(t=i),i=e[e.length-1].index+1,void 0===t)&&i<this.pages.length&&!this.pages[i].rendered?e[e.length-1].index+1:t)&&(this.listenToOnce(this._pageRenderer,"renderQueueEmpty",this._renderHighestPriorityPage),this._pageRenderer.scheduleRender(this.pages[t],{highestPriority:!0}))},_getVisiblePages:function(){for(var e=this.el.scrollTop,i=e+this.el.clientHeight,t=[],n=0;n<this.pages.length;n++){var s=this.pages[n],o=s.getBoundsVisibility(e,i);if(!o.aboveBounds){if(o.belowBounds)break;t.push({page:s,index:n})}}return t},_getFirstVisiblePage:function(){for(var e=this.el.scrollTop,i=0;i<this.pages.length;i++){var t=this.pages[i],n=t.el;if(n.offsetTop+n.offsetHeight>=e)return t}return null},_onMouseDown:function(e){var i=$(e.target),t=i.parents(".pdf-page");if(1===e.which&&!this.isCommentDialogVisible()&&!i.hasClass("selection-flag"))return i=this.pages[t.data("pageIx")],this._activeSelection=i.beginSelection(e),!1},_onMouseUp:function(e){if(!this._activeSelection)return!0;!this.isCommentDialogVisible()&&this._activeSelection.isValid()&&(e.stopPropagation(),e=this._activeSelection.finish(e),(this._activeSelection=null)!==e)&&this.trigger("commentRegionCreated",e)},_onMouseMove:function(e){return!this._activeSelection||(!this.isCommentDialogVisible()&&this._activeSelection.isValid()?(this._activeSelection.update(e),!1):void 0)},_onScroll:function(e){for(var i=this.el.scrollTop,t=i+this.el.clientHeight,n=-1,s=0,o=0;o<this.pages.length;o++){var a=this.pages[o].getBoundsVisibility(i,t);!a.aboveBounds&&!a.belowBounds&&a.overlapSize>s&&(s=a.overlapSize,n=o)}console.assert(0<=n),this._scrolling=!0,this._pdf.set("currentPage",n+1),this._scrolling=!1,this._renderHighestPriorityPage()},_onCurrentPageChanged:function(){var e=this._pdf.get("currentPage");0===this.pages.length||this._scrolling||(console.assert(1<=e),console.assert(e<=this.pages.length),this.$el.scrollTop(this.pages[e-1].$el.position().top))},_onZoomChanged:function(){for(var n,s,o,a=this,e=this.model.get("commentBlockViews"),t=this.model.get("scale"),l=this._getFirstVisiblePage(),i=0;i<e.length;i++)e[i].model.set("scale",t);this._pdf.getPage(l.pageNum).then(function(e){var i=a.model.previous("scale"),i=e.getViewport({scale:i}),t=l.$canvas.position();s=a.el.scrollTop-t.top,o=i.convertToPdfPoint(a.el.scrollLeft-t.left,s),o=[Math.round(o[0]),Math.round(o[1])],n=e}).then(this._resizeAllPages).then(function(){var e=l.$canvas.position(),i=n.getViewport({scale:t}).convertToViewportPoint(o[0],o[1]);a.el.scrollLeft=e.left+i[0],a.el.scrollTop=e.top+(s<0?s:i[1]),a._renderHighestPriorityPage()})},_resizeAllPages:function(){for(var e={},i=0;i<this.pages.length;i++){var t=this.pages[i],n=t.$el.width()+"x"+t.$el.height();t.rendered=!1,e[n]?e[n].push(t):e[n]=[t]}return Promise.all(_.map(e,this._resizePagesBatch))},_resizePagesBatch:function(n){var s=this.model.get("scale"),o=window.devicePixelRatio;return this._pdf.getPage(n[0].pageNum).then(function(e){for(var e=e.getViewport({scale:s*o}),i={width:Math.round(e.width/o)+"px",height:Math.round(e.height/o)+"px"},t=0;t<n.length;t++)n[t].resize(i)})}}),PowerPack.PDF.RenderablePageView=Backbone.View.extend({initialize:function(e){this.pageNum=e.pageNum,this.$canvas=null,this.inRenderQueue=!1,this.rendered=!1},render:function(){return this.$canvas=$("<canvas/>"),this},resize:function(e,i){i&&this.$canvas.attr(i),this.$canvas.css(e),this.$el.css(e)}}),PowerPack.PDF.PageView=PowerPack.PDF.RenderablePageView.extend({className:"pdf-page",events:{"mousedown .selection-container":"_onMouseDown",mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave"},SELECTION_CLICK_EPSILON:5,initialize:function(e){PowerPack.PDF.RenderablePageView.prototype.initialize.call(this,e),this.diffRegions=e.diffRegions,this.pagesView=e.pagesView,this._$selectionContainer=null,this._$selectionRect=null},setDiffRegions:function(e){this.diffRegions=e,this.rendered=!1},render:function(){return PowerPack.PDF.RenderablePageView.prototype.render.call(this),this.$el.empty().data("pageIx",this.pageNum-1).attr("id","pdf-page-"+this.pageNum),this._$selectionRect=$("<div/>").addClass("selection-rect").proxyTouchEvents().hide(),this._$selectionContainer=$("<div/>").addClass("selection-container").proxyTouchEvents().hide().append(this._$selectionRect).appendTo(this.$el),this.$canvas.addClass("pdf-canvas").appendTo(this.$el),this},resize:function(e,i){PowerPack.PDF.RenderablePageView.prototype.resize.call(this,e,i),this._$selectionContainer.css(e)},getBoundsVisibility:function(e,i){var t=this.el.offsetTop,n=t+this.el.offsetHeight,s=Math.max(t,e);return{aboveBounds:n<e,belowBounds:i<t,overlapSize:Math.min(n,i)-s}},placeCommentBlockView:function(e){this._$selectionContainer.append(e.$el),e.setSelectionRegionSizeFunc&&e.setSelectionRegionSizeFunc(this._getSelectionRegionSize.bind(this))},beginSelection:function(e){var i=this,t=this.$el.offset(),n=e.pageX-Math.floor(t.left)-1,s=e.pageY-Math.floor(t.top)-1;return this._$selectionRect.move(n,s).width(1).height(1).show(),{isValid:function(){return i._$selectionRect.is(":visible")},update:function(e){return i._updateSelection(e,n,s)},finish:this._finishSelection.bind(this)}},_updateSelection:function(e,i,t){var n=this.$el,s=n.offset(),o=Math.floor(s.left)-1,s=Math.floor(s.top)-1,a=Math.floor(n.innerWidth()),n=Math.floor(n.innerHeight()),o=Math.min(Math.max(e.pageX-o,0),a-2),a=Math.min(Math.max(e.pageY-s,0),n-2);this._$selectionRect.css(i<=o?{left:i,width:o-i}:{left:o,width:i-o}).css(t<=a?{top:t,height:a-t}:{top:a,height:t-a})},_finishSelection:function(){var e,i,t,n,s=this._$selectionRect,o=s.width(),a=s.height(),l=s.position(),r=window.devicePixelRatio;return s.hide(),o<=this.SELECTION_CLICK_EPSILON||a<=this.SELECTION_CLICK_EPSILON?null:(s=this.pagesView.model.get("scale"),t=this.$canvas[0].getContext("2d"),n=Math.floor(l.left*r),e=Math.floor(l.top*r),i=Math.floor(o*r),r=Math.floor(a*r),t=t.getImageData(n,e,i,r),(n=$("<canvas>").attr({width:i,height:r})[0]).getContext("2d").putImageData(t,0,0),{x:Math.floor(l.left/s),y:Math.floor(l.top/s),width:Math.round(o/s),height:Math.round(a/s),onDiffOrigFile:this.pagesView.origFile,page:this.pageNum,thumbnailData:n.toDataURL()})},_getSelectionRegionSize:function(){var e=this._$selectionContainer,i=e.position();return i.left+=e.getExtents("m","l"),{left:i.left,top:i.top,width:e.width(),height:e.height()}},_onMouseEnter:function(){this._$selectionContainer.show()},_onMouseLeave:function(){this._$selectionRect.is(":hidden")&&!this.pagesView.isCommentDialogVisible()&&this._$selectionContainer.hide()}}),PowerPack.PDF.SidebarModeView=Backbone.View.extend({setVisible:function(e){this.$el.toggle(e)}}),i=Backbone.Model.extend({defaults:_.defaults({children:null,text:"",page:null}),parse:function(e){return{text:e.title,page:e.page,children:new t(e.children,{parse:!0})}}}),t=Backbone.Collection.extend({model:i,initialize:function(e){e=e.map(function(e){return new i(e,{parse:!0})}),Backbone.Collection.prototype.initialize.call(this,e)}}),n=Backbone.View.extend({tagName:"li",initialize:function(){this._childViews=this.model.get("children").map(function(e){return new n({model:e})})},render:function(){var i=this;return this._$disclosure=$("<div/>").addClass("disclosure").appendTo(this.el).click(this._toggleDisclosure.bind(this)),this._disclosed=!1,$("<div/>").addClass("page-link").text(this.model.get("text")).data("page",this.model.get("page")).appendTo(this.el),this._childViews.length&&(this._$ul=$("<ul/>").appendTo(this.el),this._childViews.forEach(function(e){return i._$ul.append(e.render().el)}),this._$disclosure.css("visibility","visible"),this._toggleDisclosure()),this},_toggleDisclosure:function(){void 0!==this._$disclosure&&(this._disclosed?(this._disclosed=!1,this._$disclosure.text("▶"),this._$ul.hide()):(this._disclosed=!0,this._$disclosure.text("▼"),this._$ul.show()))}}),PowerPack.PDF.SidebarModeOutlineView=PowerPack.PDF.SidebarModeView.extend({tagName:"ul",events:{"click .page-link":"_onItemClicked"},initialize:function(){this._collection=null,this._childViews=[]},render:function(){var e=this.model.get("reviewable").get("pdf");return this.stopListening(e),this.listenTo(e,"change:outlineMap",this._buildOutlineViews),this._buildOutlineViews(),this},_buildOutlineViews:function(){var i=this,e=this.model.get("reviewable").get("pdf");this._childViews.forEach(function(e){return e.remove()}),this._collection=new t(e.get("outlineMap")||[],{parse:!0}),this._childViews=[],this._collection.each(function(e){e=new n({model:e});i.$el.append(e.render().el),i._childViews.push(e)})},_onItemClicked:function(e){e=$(e.target).data("page");null!==e&&this.model.get("reviewable").get("pdf").set("currentPage",e)}}),PowerPack.PDF.SidebarControlsView=Backbone.View.extend({className:"pdf-controls-sidebar",events:{"click .toggle-sidebar":"_onToggleSidebarClicked"},initialize:function(){this._$modes=null,this._$toggleSidebar=null},render:function(){return this.stopListening(this.model),this.$el.empty(),this._$toggleSidebar=$('<span class="fa fa-bars toggle-sidebar">').attr("title",gettext("Toggle the page navigation sidebar")).appendTo(this.$el),this._$modes=$('<div class="pdf-controls-sidebar-modes">').appendTo(this.$el),this.listenTo(this.model,"change:availableModes",this._onAvailableModesChanged),this._onAvailableModesChanged(),this.listenTo(this.model,"change:visible",this._onSidebarVisibleChanged),this.listenTo(this.model,"change:mode",this._onModeChanged),this},_addSidebarMode:function(e){var i=this,t={};t[PowerPack.PDF.Sidebar.MODE_DIFFS]="fa-columns",t[PowerPack.PDF.Sidebar.MODE_OUTLINE]="fa-list",t[PowerPack.PDF.Sidebar.MODE_THUMBNAILS]="fa-file-o",$('<span class="sidebar-mode-'.concat(e," fa ").concat(t[e],'">')).on("click",function(){return i.model.set("mode",e)}).appendTo(this._$modes)},_onToggleSidebarClicked:function(){this.model.set("visible",!this.model.get("visible"))},_onAvailableModesChanged:function(){this._$modes.empty(),_.each(this.model.get("availableModes"),this._addSidebarMode,this)},_onSidebarVisibleChanged:function(){var e=this.model.get("visible");this._$toggleSidebar.toggleClass("active",e),this._$modes.toggleClass("sidebar-open",e)},_onModeChanged:function(){var e=this.model.previous("mode"),i=this.model.get("mode");this.$(".sidebar-mode-".concat(e)).removeClass("active"),this.$(".sidebar-mode-".concat(i)).addClass("active")}}),PowerPack.PDF.SidebarDiffsView=PowerPack.PDF.SidebarModeView.extend({tagName:"ul",events:{"click .page-link":"_onItemClicked"},initialize:function(){this._rendered=!1},render:function(){var o=this,e=this.model.get("reviewable"),i=e.get("diffData")||[];return this.$el.empty(),i.forEach(function(e){var i,t,n,s;e.content&&(t="insert"===e.op,i=e.page+1,n=e.syncPage+1,t=$('<li class="page-link">').addClass("pdf-nav-diffs-".concat(e.op)).data({leftPage:t?n:i,rightPage:t?i:n}).appendTo(o.$el),n=$('<div class="pdf-nav-diffs-diff">'),void 0!==e.movedWithinPage?s=interpolate(gettext("Moved within page %s"),[e.movedWithinPage+1]):void 0!==e.movedToPage?s=interpolate(gettext("Moved to page %s"),[e.movedToPage+1]):void 0!==e.movedFromPage&&(s=interpolate(gettext("Moved from page %s"),[e.movedFromPage+1])),s&&($('<div class="pdf-nav-diffs-moved-marker">').text(s).appendTo(t),n.addClass("moved")),$("<strong>").text("".concat(i," ")).appendTo(n),$("<span>").text(e.content).appendTo(n),n.appendTo(t))}),this._rendered||(this.listenTo(e,"change:diffData",this.render),this._rendered=!0),this},_onItemClicked:function(e){var e=$(e.currentTarget),i=e.data("leftPage"),e=e.data("rightPage"),t=this.model.get("reviewable");t.get("diffAgainstPDF").set("currentPage",i),t.get("pdf").set("currentPage",e)}}),PowerPack.PDF.SidebarView=Backbone.View.extend({initialize:function(e){this._pageRenderer=e.pageRenderer,this._currentView=null,this._outlineView=null,this._thumbnailsView=null},render:function(){this.model.get("reviewable").get("pdf").get("outlineMap");return this._outlineSidebarView=this._createSidebarModeView(PowerPack.PDF.SidebarModeOutlineView,this.$(".pdf-nav-outline")),this._thumbnailsSidebarView=this._createSidebarModeView(PowerPack.PDF.SidebarModeThumbnailsView,this.$(".pdf-nav-pages"),{pageRenderer:this._pageRenderer,scrollContainer:this.el}),this._sidebarDiffsView=this._createSidebarModeView(PowerPack.PDF.SidebarDiffsView,this.$(".pdf-nav-diffs")),this.listenTo(this.model,"change:mode",this._onModeChanged),this._onModeChanged(),this},_createSidebarModeView:function(e,i){var t=new e(_.defaults({model:this.model},2<arguments.length&&void 0!==arguments[2]?arguments[2]:{}));return t.render().$el.hide().appendTo(i),t},_onModeChanged:function(){var e=this.model.get("mode");this._currentSidebarView&&(this.stopListening(this._currentSidebarView,"sidebarItemSelected"),this._currentSidebarView.setVisible(!1)),e===PowerPack.PDF.Sidebar.MODE_OUTLINE?this._currentSidebarView=this._outlineSidebarView:e===PowerPack.PDF.Sidebar.MODE_THUMBNAILS?this._currentSidebarView=this._thumbnailsSidebarView:e===PowerPack.PDF.Sidebar.MODE_DIFFS&&(this._currentSidebarView=this._sidebarDiffsView),this.listenTo(this._currentSidebarView,"sidebarItemSelected",this._onSidebarItemSelected),this._currentSidebarView.setVisible(!0)}}),s=PowerPack.PDF.RenderablePageView.extend({className:"item page-thumb",events:{"click canvas":"_onCanvasClicked"},setSelected:function(e){this.$el.toggleClass("selected",e)},render:function(e){return PowerPack.PDF.RenderablePageView.prototype.render.call(this),this.$el.data("page",this.pageNum).append(this.$canvas),e.scheduleRender(this,{fitToWidth:!0}),this},_onCanvasClicked:function(e){e.preventDefault(),e.stopPropagation(),this.$el.trigger("click")}}),PowerPack.PDF.SidebarModeThumbnailsView=PowerPack.PDF.SidebarModeView.extend({className:"page-thumbs",events:{"click .item":"_onItemClicked"},initialize:function(e){this.pageRenderer=e.pageRenderer,this.scrollContainer=e.scrollContainer,this._thumbnailViews=[],this._selectedThumbnailView=null},setVisible:function(e){PowerPack.PDF.SidebarModeView.prototype.setVisible.call(this,e),e&&this._selectedThumbnailView&&this._scrollToSelectedThumbnail(!1)},render:function(){var e=this.model.get("reviewable").get("pdf");return this.listenTo(e,"change:currentPage",this._onPageNumChanged),this._onPageNumChanged(),this.listenTo(e,"change:numPages",this._renderThumbnails),this._renderThumbnails(),this},_renderThumbnails:function(){for(var e=this.model.get("reviewable").get("pdf"),i=0;i<this._thumbnailViews.length;i++)this._thumbnailViews[i].remove();this._thumbnailViews=[],this._selectedThumbnailView=null;for(var t=1;t<=e.get("numPages");t++){var n=new s({pageNum:t});n.render(this.pageRenderer).$el.appendTo(this.$el),this._thumbnailViews.push(n)}},_scrollToSelectedThumbnail:function(e){var i=this._selectedThumbnailView.$el,t=i.outerHeight(!0),i=i.position(),n=this.scrollContainer.scrollTop,s=this.scrollContainer.offsetHeight,o=null;i.top<0?o=n+i.top:i.top+t>=s&&(o=n+i.top-s+t),null!==o&&(!1!==e?$(this.scrollContainer).stop(!0).animate({scrollTop:o}):this.scrollContainer.scrollTop=o)},_onItemClicked:function(e){e=$(e.target).data("page");e&&this.model.get("reviewable").get("pdf").set("currentPage",e)},_onPageNumChanged:function(){var e=this.model.get("reviewable").get("pdf").get("currentPage");null!==e&&0!==this._thumbnailViews.length&&(e=this._thumbnailViews[e-1],this._selectedThumbnailView&&this._selectedThumbnailView.setSelected(!1),e.setSelected(!0),this._selectedThumbnailView=e,this._scrollToSelectedThumbnail())}}),PowerPack.PDF.RegionCommentBlockView=RB.RegionCommentBlockView.extend({initialize:function(){RB.RegionCommentBlockView.prototype.initialize.call(this),this.model.on("change:scale",this._updateDimensions,this)},_updateDimensions:function(){var e=this.model,i=e.get("scale");this.$el.move(e.get("x")*i,e.get("y")*i,"absolute").width(e.get("width")*i).height(e.get("height")*i)}}),PowerPack.PDF.ReviewableView=RB.FileAttachmentReviewableView.extend({className:"pdf-review-ui",commentBlockView:PowerPack.PDF.RegionCommentBlockView,template:'<div class="pdf-controls review-ui-header">\n <div class="pdf-controls-sidebar"></div>\n <div class="pdf-controls-center-outer">\n  <div class="pdf-controls-center-inner">\n   <div class="pdf-controls-page"></div>\n  </div>\n </div>\n <div class="pdf-controls-zoom"></div>\n <div class="pdf-controls-revision"></div>\n</div>\n<div class="pdf-lower">\n <div class="pdf-nav">\n  <div class="pdf-nav-outline"></div>\n  <div class="pdf-nav-pages"></div>\n  <div class="pdf-nav-diffs"></div>\n </div>\n</div>',spinnerTemplate:_.template('<div class="pdf-controls-diff-loading">\n <span class="fa fa-spinner fa-pulse"></span>\n <%- spinnerText %>\n</div>'),initialize:function(e){var t=this,e=(RB.AbstractReviewableView.prototype.initialize.call(this,e),this.model.get("pdf")),i=this.model.get("diffAgainstPDF");this._activeSelection=null,this._bottomSpacing=null,this._sidebarView=null,this._pageControlsView=null,this._sidebarControlsView=null,this._zoomControlsView=null,this._pagesView=null,this._sidebar=new PowerPack.PDF.Sidebar({reviewable:this.model}),this._pageRenderer=new PowerPack.PDF.PageRendererView({model:this.model,pdf:e}),this._scrollLock=!0,this._blockScrollHandler=!1,i&&(this._diffPageRenderer=new PowerPack.PDF.PageRendererView({model:this.model,pdf:i})),this._$lower=null,this._$window=$(window),this._$window.resize(_.bind(this._onWindowResize,this)),location.hash&&"#page-"===location.hash.slice(0,6)&&e.set("currentPage",parseInt(location.hash.slice(6),10)),this.on("commentBlockViewAdded",function(i){var e=i.model.get("onDiffOrigFile")?t._diffAgainstPagesView:t._pagesView;e&&0<e.pages.length&&e.placeCommentBlockView(i.model.get("page"),i),i.model.set("scale",t.model.get("scale")),t.model.get("commentBlockViews").push(i),i.on("remove",function(){var e=t.model.get("commentBlockViews"),e=_.without(e,i);t.model.set("commentBlockViews",e)})})},renderContent:function(){var e=this,i=(this.$el.html(this.template),this._$lower=this.$(".pdf-lower"),this._sidebarView=new PowerPack.PDF.SidebarView({el:this.$(".pdf-nav"),model:this._sidebar,pageRenderer:this._pageRenderer}),this._sidebarView.render(),this.listenTo(this._sidebarView,"selectPage",this._jumpToPage),this._sidebarControlsView=new PowerPack.PDF.SidebarControlsView({el:this.$(".pdf-controls-sidebar"),model:this._sidebar}),this._sidebarControlsView.render(),this._pageControlsView=new PowerPack.PDF.PageControlsView({el:this.$(".pdf-controls-page"),model:this.model}),this._pageControlsView.render(),this._zoomControlsView=new PowerPack.PDF.ZoomControlsView({el:this.$(".pdf-controls-zoom"),model:this.model}),this._zoomControlsView.render(),1<this.model.get("numRevisions")&&(i=this.$(".pdf-controls-revision"),t=$('<div id="revision_label">').appendTo(i),this._revisionLabelView=new RB.FileAttachmentRevisionLabelView({el:t,model:this.model}),this._revisionLabelView.render(),t=$('<div id="attachment_revision_selector">').appendTo(i),this._revisionSelectorView=new RB.FileAttachmentRevisionSelectorView({el:t,model:this.model}),this._revisionSelectorView.render(),this.listenTo(this._revisionLabelView,"revisionSelected",this._onRevisionSelected),this.listenTo(this._revisionSelectorView,"revisionSelected",this._onRevisionSelected)),void 0!==this._diffPageRenderer),t=(i&&(t=$('<div class="pdf-offset diff">').appendTo(this._$lower),this._diffAgainstPagesView=new PowerPack.PDF.PagesView({el:t,model:this.model,origFile:!0,pageRenderer:this._diffPageRenderer,pdf:this.model.get("diffAgainstPDF")}),this.listenTo(this._diffAgainstPagesView,"commentRegionCreated",this.createAndEditCommentBlock),this._diffAgainstPagesView.render()),$('<div class="pdf-offset">').toggleClass("diff",i).toggleClass("diff-right",i).appendTo(this._$lower));return this._pagesView=new PowerPack.PDF.PagesView({el:t,model:this.model,origFile:!1,pageRenderer:this._pageRenderer,pdf:this.model.get("pdf")}),this.listenTo(this._pagesView,"commentRegionCreated",this.createAndEditCommentBlock),this._pagesView.render(),i&&((t=this.model.get("diffData"))?this._applyDiffData(t):_.defer(this._loadDiffData.bind(this)),this._diffAgainstPagesView.$el.on("scroll",function(){e._lockScroll(e._diffAgainstPagesView,e._pagesView)}),this._pagesView.$el.on("scroll",function(){e._lockScroll(e._pagesView,e._diffAgainstPagesView)}),this.listenTo(this.model,"change:scrollLock",function(){e._lockScroll(e._diffAgainstPagesView,e._pagesView)})),this.listenTo(this._sidebar,"change:visible",this._onSidebarToggled),_.defer(this._onWindowResize.bind(this)),this},_loadDiffData:function(){var i=this,t=$('<div class="pdf-shimmer">').appendTo(this._$lower),n=$(this.spinnerTemplate({spinnerText:gettext("Loading diffs...")})).appendTo(this.$(".pdf-controls-revision"));function s(e){alert("Failed to generate PDF diffs: "+e),n.remove(),t.remove()}$.ajax(this.model.get("diffURL")).done(function(e){"success"===e.result?(t.remove(),n.remove(),i.model.set("diffData",e.data),i._applyDiffData(e.data)):s(e.error)}).fail(function(e,i){var e=e.responseText,t=null;try{t=JSON.parse(e)}catch(e){}s(e=t&&t.error?t.error:e)})},_applyDiffData:function(e){this._diffAgainstPagesView.addDiffRegions(e.filter(function(e){return"delete"===e.op})),this._pagesView.addDiffRegions(e.filter(function(e){return"insert"===e.op}))},_lockScroll:function(e,i){this.model.get("scrollLock")&&!this._blockScrollHandler&&(this._blockScrollHandler=!0,i.$el.scrollTop(e.el.scrollTop),this._blockScrollHandler=!1)},_onRevisionSelected:function(e){var i=this.model.get("attachmentRevisionIDs"),t=e[0],e=e[1];0!==e&&(e=i[e-1],t=(0===t?"../":(i=i[t-1],"../".concat(i,"-"))).concat(e,"/"),window.location.replace(t))},_onWindowResize:function(){this.el.parentElement&&this._$lower.height(this._$window.height()-this._$lower.offset().top-this._getBottomSpacing()-1)},_getBottomSpacing:function(){var i=this;return null===this._bottomSpacing&&(this._bottomSpacing=0,_.each(this.$el.parents(),function(e){i._bottomSpacing+=$(e).getExtents("bmp","b")})),this._bottomSpacing},_onSidebarToggled:function(){var e=this._sidebar.get("visible");this._sidebarView.$el.toggleClass("sidebar-open",e),this._pagesView.$el.toggleClass("sidebar-open",e),this._diffAgainstPagesView&&this._diffAgainstPagesView.$el.toggleClass("sidebar-open",e),this._onWindowResize()}}),PowerPack.PDF.ZoomControlsView=Backbone.View.extend({className:"pdf-controls-zoom",events:{"click .zoom-out":"_onZoomOut","click .zoom-in":"_onZoomIn"},template:_.template('<div class="fa fa-search-minus zoom-out"\n     title="<%- zoomOutText %>"></div>\n<div class="fa fa-search-plus zoom-in"\n     title="<%- zoomInText %>"></div>'),render:function(){return this.$el.html(this.template({zoomOutText:gettext("Zoom out"),zoomInText:gettext("Zoom in")})),this},_onZoomOut:function(){this.model.set("scale",Math.floor(.75*this.model.get("scale")*10)/10)},_onZoomIn:function(){this.model.set("scale",Math.ceil(this.model.get("scale")*(4/3)*10)/10)}})}.call(this);
