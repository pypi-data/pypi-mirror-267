{"version":3,"file":"c.BBjzgY5c.js","sources":["../../../../src/util/line-break-transformer.ts","../../../../src/logs-webserial/ewt-console.ts","../../../../src/logs-webserial/logs-webserial-dialog.ts"],"sourcesContent":["export class LineBreakTransformer implements Transformer<string, string> {\n  private chunks = \"\";\n\n  transform(\n    chunk: string,\n    controller: TransformStreamDefaultController<string>,\n  ) {\n    // Append new chunks to existing chunks.\n    this.chunks += chunk;\n    // For each line breaks in chunks, send the parsed lines out.\n    const lines = this.chunks.split(\"\\r\\n\");\n    this.chunks = lines.pop()!;\n    lines.forEach((line) => controller.enqueue(line + \"\\r\\n\"));\n  }\n\n  flush(controller: TransformStreamDefaultController<string>) {\n    // When the stream is closed, flush any remaining chunks out.\n    controller.enqueue(this.chunks);\n  }\n}\n","import { ColoredConsole, coloredConsoleStyles } from \"../util/console-color\";\nimport { sleep } from \"../util/sleep\";\nimport { LineBreakTransformer } from \"../util/line-break-transformer\";\nimport { Logger } from \"../const\";\n\nexport class EwtConsole extends HTMLElement {\n  public port!: SerialPort;\n  public logger!: Logger;\n  public allowInput = true;\n\n  private _console?: ColoredConsole;\n  private _cancelConnection?: () => Promise<void>;\n\n  public logs(): string {\n    return this._console?.logs() || \"\";\n  }\n\n  public connectedCallback() {\n    if (this._console) {\n      return;\n    }\n    const shadowRoot = this.attachShadow({ mode: \"open\" });\n\n    shadowRoot.innerHTML = `\n      <style>\n        :host, input {\n          background-color: #1c1c1c;\n          color: #ddd;\n          font-family: \"SFMono-Regular\", Consolas, \"Liberation Mono\", Menlo, Courier,\n            monospace;\n          line-height: 1.45;\n          display: flex;\n          flex-direction: column;\n        }\n        form {\n          display: flex;\n          align-items: center;\n          padding: 0 8px 0 16px;\n        }\n        input {\n          flex: 1;\n          padding: 4px;\n          margin: 0 8px;\n          border: 0;\n          outline: none;\n        }\n        ${coloredConsoleStyles}\n      </style>\n      <div class=\"log\"></div>\n      ${\n        this.allowInput\n          ? `<form>\n                >\n                <input autofocus>\n              </form>\n            `\n          : \"\"\n      }\n    `;\n\n    this._console = new ColoredConsole(this.shadowRoot!.querySelector(\"div\")!);\n\n    if (this.allowInput) {\n      const input = this.shadowRoot!.querySelector(\"input\")!;\n\n      this.addEventListener(\"click\", () => {\n        // Only focus input if user didn't select some text\n        if (getSelection()?.toString() === \"\") {\n          input.focus();\n        }\n      });\n\n      input.addEventListener(\"keydown\", (ev) => {\n        if (ev.key === \"Enter\") {\n          ev.preventDefault();\n          ev.stopPropagation();\n          this._sendCommand();\n        }\n      });\n    }\n\n    const abortController = new AbortController();\n    const connection = this._connect(abortController.signal);\n    this._cancelConnection = () => {\n      abortController.abort();\n      return connection;\n    };\n  }\n\n  private async _connect(abortSignal: AbortSignal) {\n    this.logger.debug(\"Starting console read loop\");\n    try {\n      await this.port\n        .readable!.pipeThrough(new TextDecoderStream(), {\n          signal: abortSignal,\n        })\n        .pipeThrough(new TransformStream(new LineBreakTransformer()))\n        .pipeTo(\n          new WritableStream({\n            write: (chunk) => {\n              this._console!.addLine(chunk.replace(\"\\r\", \"\"));\n            },\n          }),\n        );\n      if (!abortSignal.aborted) {\n        this._console!.addLine(\"\");\n        this._console!.addLine(\"\");\n        this._console!.addLine(\"Terminal disconnected\");\n      }\n    } catch (e) {\n      this._console!.addLine(\"\");\n      this._console!.addLine(\"\");\n      this._console!.addLine(`Terminal disconnected: ${e}`);\n    } finally {\n      await sleep(100);\n      this.logger.debug(\"Finished console read loop\");\n    }\n  }\n\n  private async _sendCommand() {\n    const input = this.shadowRoot!.querySelector(\"input\")!;\n    const command = input.value;\n    const encoder = new TextEncoder();\n    const writer = this.port.writable!.getWriter();\n    await writer.write(encoder.encode(command + \"\\r\\n\"));\n    this._console!.addLine(`> ${command}\\r\\n`);\n    input.value = \"\";\n    input.focus();\n    try {\n      writer.releaseLock();\n    } catch (err) {\n      console.error(\"Ignoring release lock error\", err);\n    }\n  }\n\n  public async disconnect() {\n    if (this._cancelConnection) {\n      await this._cancelConnection();\n      this._cancelConnection = undefined;\n    }\n  }\n\n  public async reset() {\n    this.logger.debug(\"Triggering reset.\");\n    await this.port.setSignals({\n      dataTerminalReady: false,\n      requestToSend: true,\n    });\n    await this.port.setSignals({\n      dataTerminalReady: false,\n      requestToSend: false,\n    });\n    await new Promise((resolve) => setTimeout(resolve, 1000));\n  }\n}\n\ncustomElements.define(\"ewt-console\", EwtConsole);\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"ewt-console\": EwtConsole;\n  }\n}\n","import { LitElement, html, css, PropertyValues } from \"lit\";\nimport { customElement, property, query, state } from \"lit/decorators.js\";\nimport \"@material/mwc-dialog\";\nimport \"@material/mwc-button\";\nimport \"./ewt-console\";\nimport { textDownload } from \"../util/file-download\";\nimport type { EwtConsole } from \"./ewt-console\";\nimport { basename } from \"../util/basename\";\nimport { openEditDialog } from \"../editor\";\nimport { getConfiguration } from \"../api/configuration\";\nimport { esphomeDialogStyles } from \"../styles\";\n\n@customElement(\"esphome-logs-webserial-dialog\")\nclass ESPHomeLogsWebSerialDialog extends LitElement {\n  @property() public configuration?: string;\n\n  @property() public port!: SerialPort;\n\n  @property() public closePortOnClose!: boolean;\n\n  @query(\"ewt-console\") private _console!: EwtConsole;\n\n  @state() private _isPico = false;\n\n  protected render() {\n    return html`\n      <mwc-dialog\n        open\n        .heading=${this.configuration ? `Logs ${this.configuration}` : \"Logs\"}\n        scrimClickAction\n        @closed=${this._handleClose}\n      >\n        <ewt-console\n          .port=${this.port}\n          .logger=${console}\n          .allowInput=${false}\n        ></ewt-console>\n        <mwc-button\n          slot=\"secondaryAction\"\n          label=\"Download Logs\"\n          @click=${this._downloadLogs}\n        ></mwc-button>\n        ${this.configuration\n          ? html`\n              <mwc-button\n                slot=\"secondaryAction\"\n                dialogAction=\"close\"\n                label=\"Edit\"\n                @click=${this._openEdit}\n              ></mwc-button>\n            `\n          : \"\"}\n        ${this._isPico\n          ? \"\"\n          : html`\n              <mwc-button\n                slot=\"secondaryAction\"\n                label=\"Reset Device\"\n                @click=${this._resetDevice}\n              ></mwc-button>\n            `}\n        <mwc-button\n          slot=\"primaryAction\"\n          dialogAction=\"close\"\n          label=\"Close\"\n        ></mwc-button>\n      </mwc-dialog>\n    `;\n  }\n\n  protected firstUpdated(changedProps: PropertyValues) {\n    super.firstUpdated(changedProps);\n    if (this.configuration) {\n      getConfiguration(this.configuration).then((config) => {\n        this._isPico = config.esp_platform === \"RP2040\";\n      });\n    }\n  }\n\n  private async _openEdit() {\n    if (this.configuration) openEditDialog(this.configuration);\n  }\n\n  private async _handleClose() {\n    await this._console.disconnect();\n    if (this.closePortOnClose) {\n      await this.port.close();\n    }\n    this.parentNode!.removeChild(this);\n  }\n\n  private async _resetDevice() {\n    await this._console.reset();\n  }\n\n  private _downloadLogs() {\n    textDownload(\n      this._console.logs(),\n      `${\n        this.configuration ? `${basename(this.configuration)}_logs` : \"logs\"\n      }.txt`,\n    );\n  }\n\n  static styles = [\n    esphomeDialogStyles,\n    css`\n      mwc-dialog {\n        --mdc-dialog-max-width: 90vw;\n      }\n      ewt-console {\n        width: calc(80vw - 48px);\n        height: calc(90vh - 128px);\n      }\n    `,\n  ];\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"esphome-logs-webserial-dialog\": ESPHomeLogsWebSerialDialog;\n  }\n}\n"],"names":["LineBreakTransformer","constructor","this","chunks","transform","chunk","controller","lines","split","pop","forEach","line","enqueue","flush","EwtConsole","HTMLElement","allowInput","logs","_a","_console","connectedCallback","attachShadow","mode","innerHTML","coloredConsoleStyles","ColoredConsole","shadowRoot","querySelector","input","addEventListener","getSelection","toString","focus","ev","key","preventDefault","stopPropagation","_sendCommand","abortController","AbortController","connection","_connect","signal","_cancelConnection","abort","abortSignal","logger","debug","port","readable","pipeThrough","TextDecoderStream","TransformStream","pipeTo","WritableStream","write","addLine","replace","aborted","e","sleep","command","value","encoder","TextEncoder","writer","writable","getWriter","encode","releaseLock","err","console","error","disconnect","undefined","reset","setSignals","dataTerminalReady","requestToSend","Promise","resolve","setTimeout","customElements","define","ESPHomeLogsWebSerialDialog","LitElement","_isPico","render","html","configuration","_handleClose","_downloadLogs","_openEdit","_resetDevice","firstUpdated","changedProps","super","getConfiguration","then","config","esp_platform","openEditDialog","closePortOnClose","close","parentNode","removeChild","textDownload","basename","styles","esphomeDialogStyles","css","__decorate","property","prototype","query","state","customElement"],"mappings":"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"}